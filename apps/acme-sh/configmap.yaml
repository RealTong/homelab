apiVersion: v1
kind: ConfigMap
metadata:
  name: acme-sh-scripts
  namespace: homelab
data:
  entrypoint.sh: |
    #!/bin/sh
    set -eu

    : "${LE_CONFIG_HOME:=/acme.sh}"
    : "${ACME_DOMAIN:=wst.sh}"
    : "${ACME_SERVER:=letsencrypt}"
    : "${ACME_SECRET_NAME:=wst-sh-wildcard-tls}"
    : "${ACME_TARGET_NAMESPACES:=auth,homelab,observability,databases,beszel-hub}"

    if [ -z "${ACME_EMAIL:-}" ]; then
      echo "ACME_EMAIL is required" >&2
      exit 1
    fi
    if [ -z "${CF_Token:-}" ] || [ -z "${CF_Zone_ID:-}" ]; then
      echo "CF_Token and CF_Zone_ID are required for dns_cf" >&2
      exit 1
    fi

    apk add --no-cache kubectl >/dev/null

    if [ ! -f "${LE_CONFIG_HOME}/${ACME_DOMAIN}/${ACME_DOMAIN}.cer" ]; then
      acme.sh --register-account -m "${ACME_EMAIL}" --server "${ACME_SERVER}" --home "${LE_CONFIG_HOME}"
      acme.sh --issue --dns dns_cf -d "${ACME_DOMAIN}" -d "*.${ACME_DOMAIN}" --server "${ACME_SERVER}" --home "${LE_CONFIG_HOME}"
    fi

    acme.sh --install-cert -d "${ACME_DOMAIN}" \
      --key-file "${LE_CONFIG_HOME}/certs/tls.key" \
      --fullchain-file "${LE_CONFIG_HOME}/certs/tls.crt" \
      --reloadcmd "/scripts/deploy.sh" \
      --home "${LE_CONFIG_HOME}"

    /scripts/deploy.sh

    exec /entry.sh daemon

  deploy.sh: |
    #!/bin/sh
    set -eu

    : "${LE_CONFIG_HOME:=/acme.sh}"
    : "${ACME_SECRET_NAME:=wst-sh-wildcard-tls}"
    : "${ACME_TARGET_NAMESPACES:=auth,homelab,observability,databases,beszel-hub}"

    cert_dir="${LE_CONFIG_HOME}/certs"
    tls_crt="${cert_dir}/tls.crt"
    tls_key="${cert_dir}/tls.key"

    if [ ! -f "${tls_crt}" ] || [ ! -f "${tls_key}" ]; then
      echo "Missing certificate files in ${cert_dir}" >&2
      exit 1
    fi

    for ns in $(echo "${ACME_TARGET_NAMESPACES}" | tr ',' ' '); do
      if ! kubectl get namespace "${ns}" >/dev/null 2>&1; then
        echo "Skipping missing namespace: ${ns}" >&2
        continue
      fi
      kubectl -n "${ns}" create secret tls "${ACME_SECRET_NAME}" \
        --cert="${tls_crt}" \
        --key="${tls_key}" \
        --dry-run=client -o yaml | kubectl apply -f -
    done
