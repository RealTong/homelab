apiVersion: apps/v1
kind: Deployment
metadata:
  name: sub2api
  namespace: homelab
  annotations:
    glance/icon: simple-icons:openai
    glance/name: "Sub2API"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sub2api
  template:
    metadata:
      labels:
        app: sub2api
    spec:
      nodeSelector:
        kubernetes.io/hostname: "realtong-server"
      initContainers:
        - name: init-db
          image: postgres:15-alpine
          command:
            - sh
            - -c
            - |
              export PGPASSWORD="$POSTGRES_ADMIN_PASSWORD"

              # Create database if not exists (use postgres default database)
              psql -h postgres.databases.svc.cluster.local -U "$POSTGRES_ADMIN_USER" -d postgres -v dbname="$DB_POSTGRESDB_DATABASE" -tc "SELECT 1 FROM pg_database WHERE datname = :'dbname'" | grep -q 1 || \
              psql -h postgres.databases.svc.cluster.local -U "$POSTGRES_ADMIN_USER" -d postgres -v dbname="$DB_POSTGRESDB_DATABASE" -c 'CREATE DATABASE :"dbname";'

              # Create user if not exists
              psql -h postgres.databases.svc.cluster.local -U "$POSTGRES_ADMIN_USER" -d postgres -v username="$DB_POSTGRESDB_USER" -tc "SELECT 1 FROM pg_user WHERE usename = :'username'" | grep -q 1 || \
              psql -h postgres.databases.svc.cluster.local -U "$POSTGRES_ADMIN_USER" -d postgres -v username="$DB_POSTGRESDB_USER" -v password="$DB_POSTGRESDB_PASSWORD" -c "CREATE USER :\"username\" WITH PASSWORD :'password';"

              # Grant privileges
              psql -h postgres.databases.svc.cluster.local -U "$POSTGRES_ADMIN_USER" -d postgres -v dbname="$DB_POSTGRESDB_DATABASE" -v username="$DB_POSTGRESDB_USER" -c 'GRANT ALL PRIVILEGES ON DATABASE :"dbname" TO :"username";'

              # Grant schema privileges
              psql -h postgres.databases.svc.cluster.local -U "$POSTGRES_ADMIN_USER" -d "$DB_POSTGRESDB_DATABASE" -v username="$DB_POSTGRESDB_USER" -c 'GRANT ALL ON SCHEMA public TO :"username";'

              echo "Database initialization completed successfully"
          env:
            - name: POSTGRES_ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: sub2api-secret
                  key: POSTGRES_ADMIN_USER
            - name: POSTGRES_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: sub2api-secret
                  key: POSTGRES_ADMIN_PASSWORD
            - name: DB_POSTGRESDB_DATABASE
              valueFrom:
                secretKeyRef:
                  name: sub2api-secret
                  key: DB_POSTGRESDB_DATABASE
            - name: DB_POSTGRESDB_USER
              valueFrom:
                secretKeyRef:
                  name: sub2api-secret
                  key: DB_POSTGRESDB_USER
            - name: DB_POSTGRESDB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: sub2api-secret
                  key: DB_POSTGRESDB_PASSWORD
      containers:
        - name: sub2api
          image: ghcr.io/wei-shaw/sub2api:latest
          ports:
            - containerPort: 443
          env:
            # Run mode
            - name: RUN_MODE
              valueFrom:
                secretKeyRef:
                  name: sub2api-secret
                  key: RUN_MODE
            - name: SIMPLE_MODE_CONFIRM
              valueFrom:
                secretKeyRef:
                  name: sub2api-secret
                  key: SIMPLE_MODE_CONFIRM
            # Admin credentials
            - name: ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: sub2api-secret
                  key: ADMIN_USERNAME
            - name: ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: sub2api-secret
                  key: ADMIN_PASSWORD

            # JWT configuration
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: sub2api-secret
                  key: JWT_SECRET

            # Security configuration
            - name: SECURITY_URL_ALLOWLIST_ENABLED
              valueFrom:
                secretKeyRef:
                  name: sub2api-secret
                  key: SECURITY_URL_ALLOWLIST_ENABLED
          volumeMounts:
            - name: sub2api-data
              mountPath: /app/data
            - name: config
              mountPath: /etc/sub2api
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 2Gi
          livenessProbe:
            httpGet:
              path: /setup/status
              port: 443
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /setup/status
              port: 443
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
      volumes:
        - name: sub2api-data
          persistentVolumeClaim:
            claimName: sub2api-pvc
        - name: config
          emptyDir: {}
